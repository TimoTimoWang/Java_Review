# Mysql高级知识点

### 一、预备知识

固态磁盘可以加强随机读写的性能。
相比机械磁盘固态磁盘支持更好的并发。
固态磁盘更容易损毁。

SSD PCI-E SSD

适用于存在大量随机IO的场景。
使用于解决单线程负载的IO瓶颈。

SSD易损耗，单线程，因此使用与从服务器上。

centos内核相关参数（/etc/sysctl.conf）

<font color=red>innodb在5.7之后支持全文索引和空间函数。</font>

**阻塞和死锁：**

- 阻塞是锁与锁之间的相互等待而产生的，比如一个资源加了互斥锁，一个事务的访问的
  同时其他事务需要阻塞等待该事务释放锁。

- 死锁：死锁是因为多个事务之间相互占用对方的资源而产生的。

Myisam存储引擎：
	索引在内存当中，数据在OS中。
InnoDB存储引擎：
	索引和数据都在内存当中。

**磁盘的配置和选择：**
	1.使用传统机器硬盘。
	2.使用RAID增强传统机器硬盘的性能。
	3.使用固态存储SSD和PCIe卡。
	4.使用网络存储NAS和SAN。

**传统机器硬盘取数据的过程：**
	1.移动磁头到磁盘表面上的正确位置。
	2.等待磁盘旋转，使的所需的数据在磁头之下。
	3.等待磁盘旋转过去，所有所需的数据都被磁头读出。

**使用RAID增加传统机器硬盘的性能：**
	RAID：全称磁盘冗余队列的简称
	简单来说RAID的作用就是可以把多个容量较小的磁盘组成一组容量更大的磁盘，
	并提供数据冗余来保证数据完整性的技术。
	

	RAID0是最早出现的RAID模式，也称为数据条带。是组建磁盘阵列中最简单的
	一种形式，只需要2块以上的磁盘即可，成本低，可以提高整个磁盘的性能和吞吐量。
	RAID0没有提供冗余或错误修复能力，但是实现成本是最低的。
	
	RAID1又称磁盘镜像，原理是把一个磁盘的数据镜像到另一个磁盘上，也就是说
	数据在写入一块磁盘的同时，会在另一块闲置的磁盘上生成镜像文件，在不影响
	性能情况下最大限度的保证系统的可靠性和可修复性。
	
	RAID5又称为分布式奇偶校验磁盘阵列。通过分布式奇偶校验把数据分散到多个
	磁盘上，这样如果任何一个盘数据失效，都可以从奇偶校验块中重建。但是如果
	两块磁盘失效，则整个卷的数据都无法恢复。
	
	RAID10又称分片的镜像。它是对磁盘先做RAID1之后对两组RAID1的磁盘再
	做RAID0，所以对读写都有良好的性能，相对于RAID5重建起来更简单，速度
	也更快。


### 二、MySQL存储引擎分类

**1.Myisam存储引擎**

mysql 5.5之前默认的存储引擎。

临时表：在排序，分组等操作中，如果数据超过一定的大小之后，由查询优化器会创建临时表。

表损坏检查或者修复：

```sql
check table tablename
repair table tablename
```

myisam支持全文索引，针对text，blob类型的字段数据可以对前500个字符建立前缀索引。

myisam支持数据压缩`myisampack`

例：`myisam -b -f myisam.MYI`

在mysql5.0之前的版本表的最大存储大小为4G，如果需要存储大表，需要修改参数：

```
MAX_ROWS
AVG_ROW_LENGTH
```

版本大于5.0的时候默认支持256TB大小。

使用场景：

- 非事务场景。
- 只读类场景。
- 空间类应用。

**2.Innodb存储引擎**

支持行锁，表锁。

支持事务，默认的事务级别为RR（可重复读）。

四种事务隔离级别：

- 读未提交
- 读已提交
- 可重复读
- 可串行化

（1）读未提交

```
事务A：insert into table value('');未提交。
事务B：select * from table；未提交。
此时B读到未提交的数据，容易产生脏读现象。
```

（2）读已提交

```
事务A：select * from t where id=1;
结果为shinelon
事务B：update t set name=lisan where id=1;已提交
事务A重复上面的查询语句，查询到shinelon
此时造成了不可重复读现象

事务A：查询一条ID为2的数据不存在。
事务B：插入了一条ID为2的数据。
事务A：准备插入一条ID为2的数据，结果产生了冲突。
此时产生了幻读的现象。
```

（3）可重复读

- 在唯一索引使用唯一的查询条件，使用记录锁。
- 查询范围上使用间隙锁与临键锁，锁住索引记录之间的范围，避免范围查询插入记录，以避免产生幻影行记录，以避免不可重读问题。

（4）可串行化

并发度最低的隔离级别。一般不会使用。



Innodb使用表空间进行存储。

表空间（innodb_file_per_table）：

- 系统表空间：off
- 独立表空间：on

系统表空间与独立表空间的选择：

- 系统表不会压缩文件，系统表空间会产生IO瓶颈。
- 独立表空间可以使用optimize table来收缩表大小。独立表空间可以向多个文件刷新数据。

<font color=red>innodb建议使用独立表空间</font>

如何将系统表空间中的数据转移到独立表空间：

1. 使用mysqldump出所有的表数据
2. 停止mysql服务，修改参数配置，删除Innodb相关文件。
3. 重启mysql服务器，重建表空间结构
4. 导入数据

ACID特性：

- 原子性
- 一致性
- 隔离性
- 持久性



innodb为何可以达到很高的并发量：

- 使用MVCC多版本控制
- 使用redo日志保证已经提交的事务可以恢复
- 使用undo日志保证没有提交的日志可以回滚



Innodb锁的类型：

- 共享锁（读锁）
- 独占锁（写锁）
- 记录锁
- 间隙锁
- 临键锁

innodb引擎状态检查：

```
show engine innodb status;
```

**3.CSV存储引擎**

数据格式使用CSV格式进行存储

.CSV存储数据内容以及元数据信息

.frm存储表空间结构信息。

所有列都不允许为null。

不支持索引，不适合大表，不适合在线处理。

